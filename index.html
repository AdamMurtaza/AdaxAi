<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Diagnostic Mode</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 40px auto; padding: 20px; background: #f4f4f9; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #status-box { padding: 10px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .error { background: #fee2e2; color: #dc2626; border: 1px solid #f87171; }
        .success { background: #dcfce7; color: #16a34a; border: 1px solid #4ade80; }
        #progress-container { width: 100%; background: #eee; border-radius: 10px; height: 20px; display: none; margin-top: 10px; }
        #progress-bar { width: 0%; height: 100%; background: #3b82f6; border-radius: 10px; transition: width 0.3s; }
    </style>
</head>
<body>

<div class="card">
    <h2>AI Hardware Check</h2>
    <div id="status-box">Detecting hardware...</div>
    
    <div id="progress-container">
        <div id="progress-bar"></div>
    </div>
    <p id="details">Waiting to initialize...</p>

    <div id="chat-area" style="display:none;">
        <hr>
        <input type="text" id="user-input" placeholder="Type here..." style="width:70%; padding:10px;">
        <button onclick="send()" style="padding:10px;">Send</button>
        <div id="response" style="margin-top:20px; white-space: pre-wrap;"></div>
    </div>
</div>

<script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";

    const statusBox = document.getElementById('status-box');
    const details = document.getElementById('details');
    const progressBar = document.getElementById('progress-bar');
    const progressCont = document.getElementById('progress-container');

    async function checkAndRun() {
        // 1. Check if the browser even knows what WebGPU is
        if (!navigator.gpu) {
            statusBox.innerText = "‚ùå WebGPU NOT SUPPORTED";
            statusBox.className = "error";
            details.innerHTML = "Your browser is too old or doesn't support WebGPU. <br><br><b>Fix:</b> Use the latest version of <b>Google Chrome</b> or <b>Microsoft Edge</b>.";
            return;
        }

        try {
            // 2. Try to actually talk to your Graphics Card
            const adapter = await navigator.gpu.requestAdapter();
            if (!adapter) {
                statusBox.innerText = "‚ùå NO GPU ADAPTER FOUND";
                statusBox.className = "error";
                details.innerText = "Your browser sees WebGPU but your computer's hardware is blocking it. This often happens on very old laptops or if 'Hardware Acceleration' is turned off in browser settings.";
                return;
            }

            // 3. If we get here, hardware is OK! Start loading.
            statusBox.innerText = "‚úÖ HARDWARE OK - LOADING BRAIN...";
            statusBox.className = "success";
            progressCont.style.display = "block";

            const engine = new webllm.MLCEngine();
            engine.setInitProgressCallback((report) => {
                const p = Math.round(report.progress * 100);
                progressBar.style.width = p + "%";
                details.innerText = report.text;
            });

            await engine.reload("Llama-3.2-1B-Instruct-q4f16_1-MLC");
            
            statusBox.innerText = "üöÄ AI ONLINE";
            document.getElementById('chat-area').style.display = "block";

            window.send = async () => {
                const input = document.getElementById('user-input').value;
                const reply = await engine.chat.completions.create({
                    messages: [{ role: "user", content: input }]
                });
                document.getElementById('response').innerText = reply.choices[0].message.content;
            };

        } catch (err) {
            statusBox.innerText = "‚ùå CRITICAL ERROR";
            statusBox.className = "error";
            details.innerText = err.message;
        }
    }

    checkAndRun();
</script>

</body>
</html>
